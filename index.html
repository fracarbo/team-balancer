<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A tool app to create balanced teams">
  <title>Team balancer</title>
  <!-- Styles and scripts-->
  <script src="https://unpkg.com/vue@3"></script>
  <link rel="stylesheet" href="./css/main.css">
  <!-- PWA -->
  <meta name="theme-color" content="#198754">
  <link rel="manifest" href="./manifest.json">
  <!-- iOS Support -->
  <link rel="apple-touch-icon" href="./img/icons/icon-96x96.png">
  <meta name="apple-mobile-web-app-status-bar" content="#198754">
</head>
<body>
  <div id="app" class="container mt-2">
    <h1 class="display-1">Team Balancer</h1>
    <section class="mb-4 card">
      <div class="card-body">
        <h2 class="card-title">New player</h2>
        <form @submit.prevent="addPlayer">
          <div class="row mb-2">
            <div class="col">
              <label>Name</label>
              <input v-model="newPlayerName" class="form-control" placeholder="Cristiano Ronaldo" required>
            </div>
            <div class="col-sm-2">
              <label>Value</label>
              <select v-model="newPlayerValue" class="form-select">
                <option v-for="n in 10" v-bind:value="n">{{ n }}</option>
              </select>
            </div>
          </div>
          <div class="d-grid gap-2">
            <button class="btn btn-success">Add player</button>    
          </div>
        </form>
      </div>
    </section>
    <div v-if="players.length > 0">
      <section class="mb-4 card">
        <div class="card-body">
          <h2 class="card-title">Players list</h2>
          <div class="list-group list-group-flush">
            <label v-for="player in players" :key="player.name" class="list-group-item">
              <input type="checkbox" v-model="player.selected" class="form-check-input me-1">
              {{ player.name }}
              <span class="badge bg-success rounded-pill">{{ player.value }}</span>
              <button @click="removePlayer(player)" class="btn btn-outline-danger btn-sm float-end">Delete</button>
            </label>
          </div>
        </div>
      </section>
      <section class="row mb-4">
        <div class="col-sm-6 mb-2">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Team A <span class="badge bg-success rounded-pill float-end">{{teamValues[0]}}</span></h3>
              <ol class="list-group list-group-numbered list-group-flush">
                <li v-for="player in balancedTeams[0]" class="list-group-item">
                  {{player.name}}
                </li>
              </ol>
            </div>
          </div>
        </div>
        <div class="col-sm-6">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">Team B <span class="badge bg-success rounded-pill float-end">{{teamValues[1]}}</span></h3>
              <ol class="list-group list-group-numbered list-group-flush">
                <li v-for="player in balancedTeams[1]" class="list-group-item">
                  {{player.name}}
                </li>
              </ol>
            </div>
          </div>
        </div>  
      </section>
      <button @click="shareTeams" class="btn btn-outline-success">Share teams</button>
    </div> 
  </div>
  <script>

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => {
            console.log("Registered");
          }).catch(err => {
            console.log('Registration failed: ', err);
          })
      })
    }

    String.prototype.toTitle = function() {
      return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
    }

    const { createApp } = Vue
    
    createApp({
      data() {
        return {
          newPlayerName: '',
          newPlayerValue: 5,
          players: JSON.parse(localStorage.getItem('players')) ?? []
        }
      },
      methods: {
        addPlayer() {
          const newPlayer = {
            name: this.newPlayerName.toTitle(),
            value: this.newPlayerValue,
            selected: true
          }
          const playerExists = this.players.filter((p) => p.name === newPlayer.name).length > 0
          if (playerExists) {
            alert("Player already exists!")
          } else {
            this.players.push(newPlayer)
            localStorage.setItem('players', JSON.stringify(this.players))
            this.newPlayerValue = 5
          }
          this.newPlayerName = ''
        },
        removePlayer(player) {
          this.players = this.players.filter(p => p.name !== player.name)
          localStorage.setItem('players', JSON.stringify(this.players))
        },
        shareTeams() {
          const teamsText = {
            a: this.balancedTeams[0].map(p => p.name).join('\n'),
            b: this.balancedTeams[1].map(p => p.name).join('\n')
          }
          const text = `
            Team A\n${teamsText.a}\n\nTeam B\n${teamsText.b}\n\nGenerated by: ${window.location.href}`
          navigator.share({
            url: window.location.url,
            text: text
          })
        }
      },
      computed: {
        selectedPlayers() {
          return this.players.filter(p => p.selected)
        },
        balancedTeams() {
          const balancer = (list) => {
            let a = [], b = []
            const m = list.map(item => item.value).reduce((prev, curr) => prev + curr, 0)
            const k = list.length / 2
            for(let i = 0; i < k; i=i+1){
              if(i%2 === 0){
                let aSum = a.map(item => item.value).reduce((prev, curr) => prev + curr, 0)
                let accettableMaxes = list.filter(x => x.value + aSum <= m)
                let max = list.filter(x => x.value == Math.max(...accettableMaxes.map(item => item.value)))[0]
                a.push(max)
                list = list.filter(item => item.name !== max.name)       
              } else {
                let min = list.filter(x => x.value === Math.min(...list.map(item => item.value)))[0]
                a.push(min)
                list = list.filter(item => item.name !== min.name)
              }
            }
            b = list
            return [a, b]
          }
          return balancer(this.selectedPlayers)
        },
        teamValues() {
          return [
            this.balancedTeams[0].reduce((acc, t) => acc + t.value, 0),
            this.balancedTeams[1].reduce((acc, t) => acc + t.value, 0)
          ]
        }
      }
    }).mount('#app')
  </script>
</body>
</html>